<script setup lang="ts">
import Popup from '@/components/futuristic/Popup.vue';
import { MessageBox } from '@/utils/message';
import { reactive, computed, ref } from 'vue';
import { UserService } from '@/servies/user';
import { useUserStore } from '@/stores/user';
import { useRoute, useRouter } from 'vue-router';
import Button from '@/components/futuristic/Button.vue'
const user = useUserStore();

const data = reactive({
    loading: false,
})
const route = useRoute();
const router = useRouter();
const popup = ref(Popup);

const btnTitle = computed(() => {
    return user.UserInfo.address ? 'Enter' : 'Connect';
})

function connect(e: Event) {
    e.preventDefault();
    if (user.UserInfo.address) {
        router.push('/');
    }
    data.loading = true
    UserService.connect().then(() => {
        data.loading = false
        if (route.path === '/home') {
            router.replace('/')
        }
    }).catch(err => {
        //4001 or other
        data.loading = false;
        MessageBox.error(err.message);
        if (err.code === undefined) {
            popup.value?.open();
        }
    })

}
function install_metamask() {
    window.open('https://metamask.io/', '_blank')
}
function close_popup() {
    popup.value?.close();
}

defineExpose({
    connect,
})
</script>
<template>
    <header class="py-4 px-28">
        <div class="flex justify-between items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="180" height="40" viewBox="0 0 180 40" fill="none">
                <path fill-rule="evenodd" clip-rule="evenodd"
                    d="M50.2047 11.3027C51.5236 10.0157 53.3035 9.29392 55.1583 9.29392H63.4361V13.5263H55.1583C54.4325 13.5263 53.736 13.8088 53.2199 14.3124L51.6953 15.8C51.1715 16.3112 50.8767 17.0079 50.8767 17.7348V23.1791C50.8767 24.0976 51.3463 24.9541 52.1253 25.4566L53.0957 26.0825C53.5441 26.3718 54.0683 26.5259 54.604 26.5259H63.4361V30.7583H54.604C53.2349 30.7583 51.8954 30.3646 50.7494 29.6253L49.779 28.9994C47.7881 27.7152 46.5881 25.5263 46.5881 23.1791V17.7348C46.5881 15.8771 47.3414 14.0965 48.68 12.7904L50.2047 11.3027Z"
                    fill="white" />
                <path fill-rule="evenodd" clip-rule="evenodd"
                    d="M73.5448 13.5002C72.0222 13.5002 70.7879 14.7184 70.7879 16.2211V23.7789C70.7879 25.2816 72.0222 26.4998 73.5448 26.4998H78.7524C80.275 26.4998 81.5093 25.2816 81.5093 23.7789V16.2211C81.5093 14.7184 80.275 13.5002 78.7524 13.5002H73.5448ZM66.4993 16.2211C66.4993 12.3809 69.6537 9.26783 73.5448 9.26783H78.7524C82.6435 9.26783 85.7979 12.3809 85.7979 16.2211V23.7789C85.7979 27.6191 82.6435 30.7322 78.7524 30.7322H73.5448C69.6537 30.7322 66.4993 27.6191 66.4993 23.7789V16.2211Z"
                    fill="white" />
                <path fill-rule="evenodd" clip-rule="evenodd"
                    d="M95.6003 13.5002C94.0777 13.5002 92.8434 14.7184 92.8434 16.2211V23.7789C92.8434 25.2816 94.0777 26.4998 95.6003 26.4998H100.808C102.331 26.4998 103.565 25.2816 103.565 23.7789V16.2211C103.565 14.7184 102.331 13.5002 100.808 13.5002H95.6003ZM88.5548 16.2211C88.5548 12.3809 91.7092 9.26783 95.6003 9.26783H100.808C104.699 9.26783 107.853 12.3809 107.853 16.2211V23.7789C107.853 27.6191 104.699 30.7322 100.808 30.7322H95.6003C91.7092 30.7322 88.5548 27.6191 88.5548 23.7789V16.2211Z"
                    fill="white" />
                <path fill-rule="evenodd" clip-rule="evenodd"
                    d="M117.656 13.5002C116.133 13.5002 114.899 14.7184 114.899 16.2211V23.7789C114.899 25.2816 116.133 26.4998 117.656 26.4998H122.863C124.386 26.4998 125.62 25.2816 125.62 23.7789V16.2211C125.62 14.7184 124.386 13.5002 122.863 13.5002H117.656ZM110.61 16.2211C110.61 12.3809 113.765 9.26783 117.656 9.26783H122.863C126.755 9.26783 129.909 12.3809 129.909 16.2211V23.7789C129.909 27.6191 126.755 30.7322 122.863 30.7322H117.656C113.765 30.7322 110.61 27.6191 110.61 23.7789V16.2211Z"
                    fill="white" />
                <path fill-rule="evenodd" clip-rule="evenodd" d="M133.585 31.0345V8.96552L137.873 8.96552V31.0345H133.585Z"
                    fill="white" />
                <path fill-rule="evenodd" clip-rule="evenodd"
                    d="M160.235 8.96552V28.616C160.235 29.9517 159.138 31.0345 157.785 31.0345H156.317C155.293 31.0345 154.353 30.4741 153.876 29.5792L145.838 14.4807V31.0345H141.549V11.384C141.549 10.0483 142.646 8.96552 144 8.96552H146.08C147.105 8.96552 148.044 9.52595 148.521 10.4208L155.947 24.3686V8.96552H160.235Z"
                    fill="white" />
                <path fill-rule="evenodd" clip-rule="evenodd"
                    d="M9.17437 3.94061C-1.5478 10.8296 -2.00429 26.9439 7.32698 34.5847C17.2704 42.7268 34.5536 38.0798 38.1176 24.8681C33.2089 31.0419 19.7882 36.2346 11.8321 29.4766C4.03688 22.8554 4.83303 11.0899 9.17437 3.94061ZM10.725 10.4362C15.0048 6.49564 21.7001 5.90587 26.6074 9.01654L30.405 4.20255C22.9684 -0.839966 12.8685 0.657132 10.725 10.4362ZM28.4308 10.4117L32.2246 5.60247C33.0437 6.31464 33.8044 7.0985 34.4968 7.94781L29.727 11.7844C29.3271 11.2939 28.8937 10.8354 28.4308 10.4117Z"
                    fill="white" />
                <path
                    d="M15.3717 24.1285C17.4878 24.1285 19.2077 22.367 19.2077 20.3183C19.2077 18.2695 17.4878 16.508 15.3717 16.508C13.2556 16.508 11.5358 18.2695 11.5358 20.3183C11.5358 22.367 13.2556 24.1285 15.3717 24.1285Z"
                    fill="white" />
                <path
                    d="M15.3717 24.1285C13.2556 24.1285 11.5358 22.367 11.5358 20.3183C11.5358 18.2695 13.2556 16.508 15.3717 16.508C17.4878 16.508 19.2077 18.2695 19.2077 20.3183C19.2077 22.367 17.4878 24.1285 15.3717 24.1285Z"
                    fill="white" />
                <path
                    d="M27.6468 24.1285C29.7629 24.1285 31.4828 22.367 31.4828 20.3183C31.4828 18.2695 29.7629 16.508 27.6468 16.508C25.5307 16.508 23.8108 18.2695 23.8108 20.3183C23.8108 22.367 25.5307 24.1285 27.6468 24.1285Z"
                    fill="white" />
                <path
                    d="M27.6468 24.1285C25.5307 24.1285 23.8108 22.367 23.8108 20.3183C23.8108 18.2695 25.5307 16.508 27.6468 16.508C29.7629 16.508 31.4828 18.2695 31.4828 20.3183C31.4828 22.367 29.7629 24.1285 27.6468 24.1285Z"
                    fill="white" />
            </svg>
            <p class="connect-btn flex items-center px-6 py-2 bg-[#182A3F] rounded-lg cursor-pointer gap-2 text-[#57BBFF]"
                @click="connect">
                <svg v-if="!user.UserInfo.address" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path
                        d="M5 7.55556V17.5694C5 18.2141 5.24915 18.8323 5.69265 19.2881C6.13615 19.7439 6.73766 20 7.36486 20H16.6351C17.2623 20 17.8638 19.7439 18.3073 19.2881C18.7508 18.8323 19 18.2141 19 17.5694V10.7639C19 10.2036 18.8117 9.66054 18.4669 9.22651C18.1222 8.79248 17.6422 8.49414 17.1081 8.38194V7.65278C17.1081 7.21443 16.9387 6.79404 16.6371 6.48409C16.3355 6.17413 15.9265 6 15.5 6H6.60811C6.19796 5.99996 5.8033 6.161 5.50487 6.45016C5.20643 6.73932 5.02677 7.13475 5.00265 7.55556H5ZM16.1622 7.65278V8.33333H6.60811C6.43249 8.33333 6.26407 8.26163 6.13989 8.134C6.01571 8.00637 5.94595 7.83327 5.94595 7.65278C5.94595 7.47228 6.01571 7.29918 6.13989 7.17155C6.26407 7.04392 6.43249 6.97222 6.60811 6.97222H15.5C15.8659 6.97222 16.1622 7.27711 16.1622 7.65278ZM14.9324 13.7778H16.6351C16.7606 13.7778 16.8809 13.829 16.9696 13.9202C17.0583 14.0113 17.1081 14.135 17.1081 14.2639C17.1081 14.3928 17.0583 14.5165 16.9696 14.6076C16.8809 14.6988 16.7606 14.75 16.6351 14.75H14.9324C14.807 14.75 14.6867 14.6988 14.598 14.6076C14.5093 14.5165 14.4595 14.3928 14.4595 14.2639C14.4595 14.135 14.5093 14.0113 14.598 13.9202C14.6867 13.829 14.807 13.7778 14.9324 13.7778Z"
                        fill="#57BBFF" />
                </svg>
                <svg v-else xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path
                        d="M5.81297 4C5.06692 4 4.35143 4.33271 3.8239 4.92493C3.29637 5.51715 3 6.32037 3 7.15789V16.8421C3 17.6796 3.29637 18.4829 3.8239 19.0751C4.35143 19.6673 5.06692 20 5.81297 20H18.187C18.9331 20 19.6486 19.6673 20.1761 19.0751C20.7036 18.4829 21 17.6796 21 16.8421V7.15789C21 6.32037 20.7036 5.51715 20.1761 4.92493C19.6486 4.33271 18.9331 4 18.187 4H5.81297ZM19.8748 16.8421C19.8748 17.3446 19.697 17.8266 19.3805 18.1819C19.064 18.5372 18.6347 18.7368 18.187 18.7368H9.37306V10.3158H19.8748V16.8421ZM19.8748 9.05263H9.37306V5.26316H18.187C18.6347 5.26316 19.064 5.46278 19.3805 5.81811C19.697 6.17345 19.8748 6.65538 19.8748 7.15789V9.05263Z"
                        fill="#57BBFF" />
                </svg>
                <span>{{ btnTitle }}</span>
            </p>
        </div>
        <Popup ref="popup">
            <template #header>
                Please install metamask first!
            </template>
            <template #body>

                <div class="mt-4 text-center w-[600px] py-4">
                    <Button type="success" @click="install_metamask">install metamask</Button>
                    <Button class="ml-2" type="default" @click="close_popup">Cancel</Button>
                </div>
            </template>
        </Popup>
    </header>
</template>
<style lang="css" scoped>
.connect-btn:hover{
    color: #fff;
}
.connect-btn:hover svg path{
    fill: #fff;
}
</style>